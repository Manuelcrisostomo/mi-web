// ================================================
// device.js - Gesti√≥n de Usuarios, Dispositivos y Perfil
// Incluye dise√±o seguro y compatibilidad con Firebase
// ================================================

// ======================= IMPORTACIONES =======================
import {
  auth, db, firestore, ref, onValue, get, remove, onAuthStateChanged
} from "../firebaseConfig.js";

import { doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { navigate } from "../app.js";
import { showHistoryUtilsPage } from "./historyUtils.js";
import { showNewHistoryPage } from "./Histors.js";
import { showPagina1, showPagina2 } from "./paginas.js";
import { showHistoryManagerPage } from "./historyManager.js";

// ================================================
// PANEL DEL ADMINISTRADOR
// ================================================
export function showAdminDashboard() {
  const root = document.getElementById("root");

  // Renderizado del panel principal de administrador
  root.innerHTML = `
    <div class="dashboard">
      <h2>Panel del Administrador</h2>
      <div id="users"></div> <!-- Lista de usuarios registrados -->
      <div class="actions">
        <button id="historyBtn">üìú Historial General</button>
        <button id="nuevoBtnAdmin">‚ú® Nuevo Bot√≥n</button>
        <button id="pagina1Btn">üìÑ P√°gina 1</button>
        <button id="pagina2Btn">üìÑ P√°gina 2</button>
        <button id="logout">Cerrar Sesi√≥n</button>
      </div>
    </div>
  `;

  // Obtener usuarios desde Realtime Database
  const usersRef = ref(db, "usuarios");
  onValue(usersRef, (snapshot) => {
    const data = snapshot.val();
    const container = document.getElementById("users");
    container.innerHTML = "<h3>Usuarios Registrados:</h3>";
    for (let id in data) {
      const user = data[id];
      container.innerHTML += `<p>üë§ ${user.nombre || "Sin nombre"} (${user.email})</p>`;
    }
  });

  // Botones de acci√≥n
  document.getElementById("logout").onclick = async () => {
    await auth.signOut();  // Cierra sesi√≥n del usuario
    navigate("login");      // Redirige a login
  };
  document.getElementById("historyBtn").onclick = () => showHistoryUtilsPage();
  document.getElementById("nuevoBtnAdmin").onclick = () => showNewHistoryPage();
  document.getElementById("pagina1Btn").onclick = () => showPagina1();
  document.getElementById("pagina2Btn").onclick = () => showPagina2();
  document.getElementById("manualPageBtn")?.onclick = () => showHistoryManagerPage();
}

// ================================================
// DASHBOARD DEL USUARIO
// ================================================
export function showUserDashboard() {
  const root = document.getElementById("root");

  // Renderizado del dashboard del usuario
  root.innerHTML = `
    <div class="dashboard">
      <h2>Perfil del Usuario</h2>
      <div id="userProfile" class="card">Cargando datos...</div> <!-- Perfil resumido -->

      <!-- Formulario de edici√≥n -->
      <form id="editForm" class="card">
        <h3>Datos Personales</h3>
        <label>Nombre:</label><input type="text" id="nombre" placeholder="Nombre completo" />
        <label>Tel√©fono:</label><input type="text" id="telefono" placeholder="Tel√©fono" />
        <label>Direcci√≥n:</label><input type="text" id="direccion" placeholder="Direcci√≥n" />
        <label>ID del Dispositivo:</label><input type="text" id="deviceId" placeholder="Ej: device_38A839E81F84" />
        <label>Rol:</label><p id="rolAsignado">Cargando...</p> <!-- Solo lectura -->

        <h3>Tipo de Mina</h3>
        <select id="tipoMina">
          <option value="">Seleccione tipo de mina</option>
          <option value="subterranea">Subterr√°nea</option>
          <option value="tajo_abierto">Tajo Abierto</option>
          <option value="aluvial">Aluvial (placer)</option>
          <option value="cantera">Cantera</option>
          <option value="pirqen">Pirqu√©n / artesanal</option>
        </select>
        <div id="camposMinaDinamicos"></div> <!-- Campos seg√∫n tipo de mina -->

        <h3>Datos T√©cnicos (Mapas/Sistema)</h3>
        <label>Latitud:</label><input type="number" id="latitude" step="any" placeholder="0" />
        <label>Longitud:</label><input type="number" id="longitude" step="any" placeholder="0" />
        <label>Altitud (m):</label><input type="number" id="altitude" step="any" placeholder="0" />
        <label>Precisi√≥n (m):</label><input type="number" id="precision" step="any" placeholder="0" />
        <label>EPSG/WGS84:</label><input type="text" id="EPSG" placeholder="WGS84" />

        <h3>Datos Geogr√°ficos / Empresariales</h3>
        <label>Pa√≠s:</label><input type="text" id="pais" placeholder="Pa√≠s" />
        <label>Regi√≥n:</label><input type="text" id="region" placeholder="Regi√≥n" />
        <label>Comuna:</label><input type="text" id="comuna" placeholder="Comuna" />
        <label>Nombre de la empresa:</label><input type="text" id="nombreEmpresa" placeholder="Nombre de la empresa" />

        <button type="submit">üíæ Guardar Cambios</button>
        <button type="button" id="deleteUser" class="delete-btn">üóëÔ∏è Borrar Usuario</button>
      </form>

      <!-- Datos del dispositivo -->
      <h3>Dispositivo Asignado</h3>
      <div id="deviceData" class="card">Cargando dispositivo...</div>

      <!-- Botones de acci√≥n -->
      <div class="actions">
        <button id="alertsBtn">Ver Alertas</button>
        <button id="devicesBtn">Ver Dispositivos</button>
        <button id="historyBtn">üìú Ver Historial</button>
        <button id="nuevoBtnUser">‚ú® Nuevo Bot√≥n</button>
        <button id="pagina1Btn">üìÑ P√°gina 1</button>
        <button id="pagina2Btn">üìÑ P√°gina 2</button>
        <button id="logoutBtn">Cerrar Sesi√≥n</button>
      </div>
    </div>
  `;

  // ======================= CAMPOS DIN√ÅMICOS SEG√öN TIPO DE MINA =======================
  const tipoMinaSelect = document.getElementById("tipoMina");
  const camposMinaDiv = document.getElementById("camposMinaDinamicos");

  tipoMinaSelect.addEventListener("change", () => {
    const tipo = tipoMinaSelect.value;
    let html = "";
    switch (tipo) {
      case "subterranea":
        html = `<h4>Datos Humanos (Operador)</h4>
                <label>Zona:</label><input type="text" id="zona" placeholder="Zona" />
                <label>Rampa:</label><input type="text" id="rampa" placeholder="Rampa" />
                <label>Galer√≠a:</label><input type="text" id="galeria" placeholder="Galer√≠a" />
                <label>Sector:</label><input type="text" id="sector" placeholder="Sector" />
                <label>Nombre de estaci√≥n:</label><input type="text" id="nombreEstacion" placeholder="Nombre de estaci√≥n" />`; break;
      case "tajo_abierto":
        html = `<h4>Datos Humanos (Operador)</h4>
                <label>Banco:</label><input type="text" id="banco" placeholder="Banco o nivel" />
                <label>Frente:</label><input type="text" id="frente" placeholder="Frente de trabajo" />
                <label>Zona:</label><input type="text" id="zona" placeholder="Zona" />
                <label>Sector:</label><input type="text" id="sector" placeholder="Sector" />`; break;
      case "aluvial":
        html = `<h4>Datos Humanos (Operador)</h4>
                <label>Mina:</label><input type="text" id="mina" placeholder="Nombre de la mina o sitio" />
                <label>R√≠o:</label><input type="text" id="rio" placeholder="R√≠o o tramo" />
                <label>Cuadrante:</label><input type="text" id="cuadrante" placeholder="Cuadrante o punto" />`; break;
      case "cantera":
        html = `<h4>Datos Humanos (Operador)</h4>
                <label>Cantera:</label><input type="text" id="cantera" placeholder="Nombre de la cantera" />
                <label>Material:</label><input type="text" id="material" placeholder="Material extra√≠do" />
                <label>Frente:</label><input type="text" id="frente" placeholder="Frente activo" />`; break;
      case "pirqen":
        html = `<h4>Datos Humanos (Operador)</h4>
                <label>Faena:</label><input type="text" id="faena" placeholder="Nombre de faena" />
                <label>Tipo de explotaci√≥n:</label><input type="text" id="tipoExplotacion" placeholder="Tipo de explotaci√≥n" />
                <label>Sector:</label><input type="text" id="sector" placeholder="Sector" />
                <label>Nivel:</label><input type="text" id="nivel" placeholder="Nivel (si aplica)" />`; break;
    }
    camposMinaDiv.innerHTML = html;
  });

  // ======================= BOTONES PRINCIPALES =======================
  document.getElementById("logoutBtn").onclick = async () => { await auth.signOut(); navigate("login"); };
  document.getElementById("alertsBtn").onclick = () => navigate("alerts");
  document.getElementById("devicesBtn").onclick = () => navigate("devices");
  document.getElementById("historyBtn").onclick = () => showHistoryUtilsPage();
  document.getElementById("nuevoBtnUser").onclick = () => showNewHistoryPage();
  document.getElementById("pagina1Btn").onclick = () => showPagina1();
  document.getElementById("pagina2Btn").onclick = () => showPagina2();

  // ======================= SINCRONIZACI√ìN DE DATOS DEL USUARIO =======================
  onAuthStateChanged(auth, async (user) => {
    if (!user) return (root.innerHTML = "<p>No hay usuario autenticado.</p>");
    const userId = user.uid;
    const userEmail = user.email;
    const userDocRef = doc(firestore, "users", userId);

    // Escucha cambios en Firestore para actualizar la UI en tiempo real
    onSnapshot(userDocRef, (docSnap) => {
      const data = docSnap.exists() ? docSnap.data() : {};
      const rolTexto = data.isAdmin ? "Administrador" : "Usuario Normal";
      document.getElementById("rolAsignado").textContent = rolTexto;

      document.getElementById("userProfile").innerHTML = `
        <p><b>Nombre:</b> ${data.nombre || "No registrado"}</p>
        <p><b>Correo:</b> ${userEmail}</p>
        <p><b>Tel√©fono:</b> ${data.telefono || "-"}</p>
        <p><b>Direcci√≥n:</b> ${data.direccion || "-"}</p>
        <p><b>Rol:</b> ${rolTexto}</p>
        <p><b>ID del Dispositivo:</b> ${data.deviceId || "No asignado"}</p>
      `;

      // Rellenar formulario con datos existentes
      const fields = ["nombre","telefono","direccion","deviceId",
                      "zona","rampa","galeria","sector","nombreEstacion",
                      "latitude","longitude","altitude","precision","EPSG",
                      "pais","region","comuna","nombreEmpresa"];
      fields.forEach(f => {
        const el = document.getElementById(f);
        if (!el) return;
        if (["latitude","longitude","altitude","precision"].includes(f)) el.value = data[f] ?? 0;
        else el.value = data[f] || "";
      });

      if (data.deviceId) mostrarDatosDispositivo(data.deviceId);
    });

    // ======================= GUARDAR CAMBIOS =======================
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const newData = {};
      const fields = ["nombre","telefono","direccion","deviceId",
                      "zona","rampa","galeria","sector","nombreEstacion",
                      "latitude","longitude","altitude","precision","EPSG",
                      "pais","region","comuna","nombreEmpresa"];
      fields.forEach(f => {
        const el = document.getElementById(f);
        if (!el) return;
        if (["latitude","longitude","altitude","precision"].includes(f)) newData[f] = parseFloat(el.value) || 0;
        else newData[f] = el.value.trim();
      });
      newData.email = userEmail;
      newData.updatedAt = new Date().toISOString();

      try {
        await setDoc(doc(firestore, "users", userId), newData, { merge: true });
        await update(ref(db, `usuarios/${userId}`), newData);
        if (newData.deviceId) mostrarDatosDispositivo(newData.deviceId);
        alert("‚úÖ Datos actualizados correctamente.");
      } catch (error) {
        console.error(error);
        alert(`‚ùå Error al guardar: ${error.message}`);
      }
    });

    // ======================= BORRAR USUARIO =======================
    document.getElementById("deleteUser").onclick = async () => {
      if (!confirm("¬øSeguro que deseas borrar este usuario?")) return;
      try {
        await deleteDoc(doc(firestore, "users", userId));
        await remove(ref(db, `usuarios/${userId}`));
        alert("üóëÔ∏è Usuario eliminado correctamente.");
        navigate("login");
      } catch (error) {
        console.error(error);
        alert(`‚ùå No se pudo borrar el usuario: ${error.message}`);
      }
    };
  });
}

// ======================= FUNCIONES DE DISPOSITIVOS =======================
function mostrarDatosDispositivo(deviceId, container = document.getElementById("deviceData")) {
  const deviceRef = ref(db, `dispositivos/${deviceId}`);
  onValue(deviceRef, (snapshot) => {
    const d = snapshot.val();
    if (!d) return (container.innerHTML = `<p>No se encontr√≥ el dispositivo: <b>${deviceId}</b></p>`);

    container.innerHTML = `
      <p><b>ID:</b> ${deviceId}</p>
      <p><b>Nombre:</b> ${d.name || "Desconocido"}</p>
      <p><b>Usuario:</b> ${d.userEmail || "Sin asignar"}</p>
      <p>Latitud: ${d.latitude ?? "‚Äî"}</p>
      <p>Longitud: ${d.longitude ?? "‚Äî"}</p>
      <p>Altitud: ${d.altitude ?? "‚Äî"}</p>
      <p>Precisi√≥n: ${d.precision ?? "‚Äî"}</p>
      <p>CO: ${d.CO ?? 0} ppm</p>
      <p>CO‚ÇÇ: ${d.CO2 ?? 0} ppm</p>
      <p>PM10: ${d.PM10 ?? 0} ¬µg/m¬≥</p>
      <p>PM2.5: ${d.PM2_5 ?? 0} ¬µg/m¬≥</p>
      <p>Humedad: ${d.humedad ?? 0}%</p>
      <p>Temperatura: ${d.temperatura ?? 0} ¬∞C</p>
      <h4>üìú √öltimos registros hist√≥ricos</h4>
      <div id="historialCarrusel" class="historialCarrusel">Cargando...</div>
      <button id="verHistorialBtn2">üìú Ver historial completo</button>
    `;
    mostrarHistorialCarrusel(deviceId);
    document.getElementById("verHistorialBtn2").onclick = () => showHistoricalPage(deviceId);
  });
}

// ======================= HISTORIAL CARRUSEL =======================
function mostrarHistorialCarrusel(deviceId) {
  const carrusel = document.getElementById("historialCarrusel");
  if (!carrusel) return console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor historialCarrusel");

  const historialRef = ref(db, `dispositivos/${deviceId}/historial`);
  onValue(historialRef, (snapshot) => {
    const historial = snapshot.val();
    carrusel.innerHTML = "";

    if (!historial) return (carrusel.innerHTML = "<p>No hay datos hist√≥ricos.</p>");

    Object.entries(historial)
      .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
      .slice(0, 12)
      .forEach(([ts, datos]) => {
        const card = document.createElement("div");
        card.className = "historialCard";
        card.innerHTML = `
          <p><b>${new Date(parseInt(ts)).toLocaleString()}</b></p>
          <p>CO: ${datos.CO ?? "‚Äî"} ppm</p>
          <p>CO‚ÇÇ: ${datos.CO2 ?? "‚Äî"} ppm</p>
          <p>PM10: ${datos.PM10 ?? "‚Äî"} ¬µg/m¬≥</p>
          <p>PM2.5: ${datos.PM2_5 ?? "‚Äî"} ¬µg/m¬≥</p>
          <p>Humedad: ${datos.humedad ?? "‚Äî"}%</p>
          <p>Temperatura: ${datos.temperatura ?? "‚Äî"} ¬∞C</p>
        `;
        carrusel.appendChild(card);
      });
  });
}

// ================================================
// FUNCIONES AUXILIARES ADICIONALES
// ================================================

// Funci√≥n para mostrar todos los dispositivos desde cualquier parte de la aplicaci√≥n
// Se utiliza en botones tipo "Ver Dispositivos" dentro del dashboard
export function showDevices() {
  // Simplemente llama a showAllDevices, que ya construye la interfaz completa
  showAllDevices();
}

// Funci√≥n para mostrar el historial completo de un dispositivo espec√≠fico
// Ya implementada arriba como showHistoricalPage()
// Esta funci√≥n se puede invocar desde botones de "Ver historial" en listas de dispositivos

// Funci√≥n para mostrar el carrusel con los √∫ltimos registros de un dispositivo
// Se utiliza en la vista del usuario para mostrar datos recientes
function mostrarHistorialCarrusel(deviceId) {
  const historialRef = ref(db, `dispositivos/${deviceId}/historial`);
  onValue(historialRef, (snapshot) => {
    const historial = snapshot.val();
    const carrusel = document.getElementById("historialCarrusel");
    carrusel.innerHTML = "";

    if (!historial) return (carrusel.innerHTML = "<p>No hay datos hist√≥ricos.</p>");

    // Ordenar del m√°s reciente al m√°s antiguo y mostrar solo los √∫ltimos 12 registros
    Object.entries(historial)
      .sort((a, b) => parseInt(b[0]) - parseInt(a[0]))
      .slice(0, 12)
      .forEach(([ts, datos]) => {
        const card = document.createElement("div");
        card.className = "historialCard"; // Estilo de tarjeta
        card.innerHTML = `
          <p><b>${new Date(parseInt(ts)).toLocaleString()}</b></p>
          <p>CO: ${datos.CO ?? "‚Äî"} ppm</p>
          <p>CO‚ÇÇ: ${datos.CO2 ?? "‚Äî"} ppm</p>
          <p>PM10: ${datos.PM10 ?? "‚Äî"} ¬µg/m¬≥</p>
          <p>PM2.5: ${datos.PM2_5 ?? "‚Äî"} ¬µg/m¬≥</p>
          <p>Humedad: ${datos.humedad ?? "‚Äî"}%</p>
          <p>Temperatura: ${datos.temperatura ?? "‚Äî"} ¬∞C</p>
        `;
        carrusel.appendChild(card);
      });
  });
}

// ================================================
// NOTAS SOBRE EL DISE√ëO Y FUNCIONALIDAD
// ================================================

// 1. La funci√≥n showAdminDashboard() crea la vista del administrador, mostrando todos los usuarios
//    y botones para historial general, p√°ginas y logout.
// 2. La funci√≥n showUserDashboard() crea la vista del usuario, permitiendo:
//    - Visualizar y editar datos personales
//    - Seleccionar tipo de mina y mostrar campos din√°micos seg√∫n selecci√≥n
//    - Visualizar dispositivo asignado y sus datos en tiempo real
//    - Acceder a alertas, historial y p√°ginas adicionales
// 3. La sincronizaci√≥n con Firebase se hace con onAuthStateChanged, onSnapshot y onValue,
//    lo que permite que los cambios se reflejen autom√°ticamente en la interfaz.
// 4. La exportaci√≥n de historial se puede hacer a CSV o Excel, incluyendo m√∫ltiples hojas
//    para separar historial local y global.
// 5. Los datos se guardan tanto en Firestore como en Realtime Database, asegurando consistencia
//    entre ambas bases.
// 6. La interfaz est√° construida en HTML din√°mico mediante template literals y manipulaciones del DOM.
// 7. Los botones de navegaci√≥n llaman a funciones importadas desde otros m√≥dulos (app.js, historyUtils.js, etc.)

// ================================================
// CONSEJOS DE USO
// ================================================

// - Mantener las funciones de Firebase separadas por responsabilidad
// - Evitar modificar el DOM directamente en bucles grandes; usar fragmentos o innerHTML por secciones
// - Validar siempre los datos antes de guardarlos en Firestore o Realtime Database
// - Asegurarse de que los IDs de los elementos HTML coincidan con los usados en el JS
// - Para campos din√°micos de minas, cualquier cambio futuro requiere actualizar el switch-case

// ================================================
// EXPORTAR HISTORIAL A EXCEL
// ================================================
async function exportToExcel(deviceId, registros) {
  // Obtener email del usuario asignado al dispositivo
  let userEmail = "Sin asignar";
  try {
    const snapshot = await get(ref(db, "usuarios"));
    const usuarios = snapshot.val() || {};
    for (let uid in usuarios) {
      if (usuarios[uid].deviceId === deviceId) {
        userEmail = usuarios[uid].email || userEmail;
        break;
      }
    }
  } catch (err) {
    console.error("Error al obtener usuario:", err);
  }

  // Crear CSV
  let csv = "Fecha,CO,CO2,PM10,PM2.5,Humedad,Temperatura,Usuario,Dispositivo\n";
  registros.forEach(([ts, valores]) => {
    const fecha = new Date(parseInt(ts)).toLocaleString("es-CL");
    csv += `"${fecha}",${valores.CO ?? ""},${valores.CO2 ?? ""},${valores.PM10 ?? ""},${valores.PM2_5 ?? ""},${valores.humedad ?? ""},${valores.temperatura ?? ""},"${userEmail}","${deviceId}"\n`;
  });

  // Descargar CSV
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `historial_${deviceId}.csv`;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ================================================
// EXPORTAR HISTORIAL A EXCEL MULTIHOJA
// ================================================
async function exportToExcelMultiSheet(deviceId, registrosLocal, registrosGlobal) {
  // Mismo proceso que exportToExcel, pero con dos hojas
  let userEmail = "Sin asignar";
  try {
    const snapshot = await get(ref(db, "usuarios"));
    const usuarios = snapshot.val() || {};
    for (let uid in usuarios) {
      if (usuarios[uid].deviceId === deviceId) {
        userEmail = usuarios[uid].email || userEmail;
        break;
      }
    }
  } catch (err) {
    console.error("Error al obtener usuario:", err);
  }

  const hojaLocal = [["Fecha","CO","CO2","PM10","PM2.5","Humedad","Temperatura","Usuario","Dispositivo"]];
  registrosLocal.forEach(([ts,valores]) => {
    hojaLocal.push([
      new Date(parseInt(ts)).toLocaleString("es-CL"),
      valores.CO ?? "",
      valores.CO2 ?? "",
      valores.PM10 ?? "",
      valores.PM2_5 ?? "",
      valores.humedad ?? "",
      valores.temperatura ?? "",
      userEmail,
      deviceId
    ]);
  });

  const hojaGlobal = [["Fecha","CO","CO2","PM10","PM2.5","Humedad","Temperatura","Usuario","Dispositivo"]];
  registrosGlobal.forEach(([ts,valores]) => {
    hojaGlobal.push([
      new Date(parseInt(ts)).toLocaleString("es-CL"),
      valores.CO ?? "",
      valores.CO2 ?? "",
      valores.PM10 ?? "",
      valores.PM2_5 ?? "",
      valores.humedad ?? "",
      valores.temperatura ?? "",
      userEmail,
      deviceId
    ]);
  });

  // Crear libro Excel con SheetJS
  const wb = XLSX.utils.book_new();
  const wsLocal = XLSX.utils.aoa_to_sheet(hojaLocal);
  const wsGlobal = XLSX.utils.aoa_to_sheet(hojaGlobal);
  XLSX.utils.book_append_sheet(wb, wsLocal, "Historial Local");
  XLSX.utils.book_append_sheet(wb, wsGlobal, "Historial Global");

  // Descargar archivo
  XLSX.writeFile(wb, `historial_${deviceId}.xlsx`);
}
// ================================================
// EXPORTAR HISTORIAL A PDF
// ================================================
function exportToPDF(deviceId, registros) {
  const doc = new jsPDF(); // Crear documento PDF
  let y = 10;

  doc.setFontSize(16);
  doc.text(`Historial del Dispositivo ${deviceId}`, 10, y);
  y += 10;

  doc.setFontSize(12);
  doc.text("Fecha | CO | CO2 | PM10 | PM2.5 | Humedad | Temperatura", 10, y);
  y += 10;

  registros.forEach(([ts,valores]) => {
    const fecha = new Date(parseInt(ts)).toLocaleString("es-CL");
    const line = `${fecha} | ${valores.CO ?? "-"} | ${valores.CO2 ?? "-"} | ${valores.PM10 ?? "-"} | ${valores.PM2_5 ?? "-"} | ${valores.humedad ?? "-"} | ${valores.temperatura ?? "-"}`;
    doc.text(line, 10, y);
    y += 7;
    if (y > 280) { // nueva p√°gina
      doc.addPage();
      y = 10;
    }
  });

  doc.save(`historial_${deviceId}.pdf`);
}
